<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartCart - Billing Information</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        .text-brand { color: #16a34a; }
        .bg-brand { background-color: #16a34a; }
        .border-brand { border-color: #16a34a; }
        .hover-bg-brand-dark:hover { background-color: #15803d; }
        .header-shadow { box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="bg-slate-100">

    <div class="bg-white min-h-screen">
        <!-- Header -->
        <header class="bg-white sticky top-0 z-50 header-shadow">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <a href="/" class="flex items-center space-x-2 text-2xl font-bold text-brand">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>
                    <span>SmartCart</span>
                </a>
                
                <!-- Navigation -->
                <div class="flex items-center space-x-4">
                    <!-- Orders Button (only show when logged in) -->
                    <a th:if="${isLoggedIn}" href="/orders" class="relative flex items-center space-x-2 bg-blue-100 text-blue-600 px-4 py-2 rounded-full hover:bg-blue-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><path d="M17.5 6.5h.01"/><path d="M6.5 6.5h.01"/><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Z"/></svg>
                        <span class="font-semibold">Orders</span>
                    </a>
                    
                    <!-- User Menu (only show when logged in) -->
                    <div th:if="${isLoggedIn}" class="relative">
                        <button class="flex items-center space-x-2 bg-slate-100 text-slate-700 px-4 py-2 rounded-full hover:bg-slate-200">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 17a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M19.001 19.001 20 20l1-1"/><path d="m20 14-1-1-1 1"/><path d="M19.001 9.001 20 8l1 1"/><path d="m20 16 1 1-1 1"/></svg>
                            <span class="font-semibold" th:text="${customer.username}">User</span>
                        </button>
                    </div>
                    
                    <a href="/cart" class="bg-brand text-white px-6 py-2 rounded-full hover-bg-brand-dark">
                        Back to Cart
                    </a>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8" data-customer th:if="${customer != null}">
            <!-- Progress Steps -->
            <div class="max-w-6xl mx-auto mb-8">
                <div class="flex items-center justify-center space-x-4 md:space-x-8">
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-brand text-white rounded-full flex items-center justify-center text-sm font-semibold">1</div>
                        <span class="text-sm font-medium text-slate-600">Cart</span>
                    </div>
                    <div class="w-12 md:w-16 h-0.5 bg-brand"></div>
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-brand text-white rounded-full flex items-center justify-center text-sm font-semibold">2</div>
                        <span class="text-sm font-medium text-brand">Billing</span>
                    </div>
                    <div class="w-12 md:w-16 h-0.5 bg-slate-300"></div>
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-slate-300 text-slate-600 rounded-full flex items-center justify-center text-sm font-semibold">3</div>
                        <span class="text-sm font-medium text-slate-400">Payment</span>
                    </div>
                    <div class="w-12 md:w-16 h-0.5 bg-slate-300"></div>
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-slate-300 text-slate-600 rounded-full flex items-center justify-center text-sm font-semibold">4</div>
                        <span class="text-sm font-medium text-slate-400">Review</span>
                    </div>
                </div>
            </div>

            <h1 class="text-3xl font-bold text-slate-800 mb-8 text-center">Billing Information</h1>
            
            <form id="billing-form" class="max-w-6xl mx-auto">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Left Side - Personal Information -->
                    <div class="bg-white border border-slate-200 rounded-xl p-6">
                        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-brand"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 17a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M19.001 19.001 20 20l1-1"/><path d="m20 14-1-1-1 1"/><path d="M19.001 9.001 20 8l1 1"/><path d="m20 16 1 1-1 1"/></svg>
                            Personal Information
                        </h2>
                        
                        <!-- Autofill Notice -->
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600 mr-2"><path d="M20 6 9 17l-5-5"/></svg>
                                <div>
                                    <p class="text-sm font-medium text-green-800">Form Pre-filled</p>
                                    <p class="text-xs text-green-600">Your information has been automatically filled from your account. You can edit any field as needed.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <!-- First Name -->
                            <div>
                                <label for="firstName" class="block text-sm font-medium text-slate-700 mb-2">First Name *</label>
                                <input type="text" id="firstName" name="firstName" required
                                       th:value="${customer?.firstName}"
                                       class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"
                                       placeholder="Enter your first name">
                            </div>

                            <!-- Last Name -->
                            <div>
                                <label for="lastName" class="block text-sm font-medium text-slate-700 mb-2">Last Name *</label>
                                <input type="text" id="lastName" name="lastName" required
                                       th:value="${customer?.lastName}"
                                       class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"
                                       placeholder="Enter your last name">
                            </div>

                            <!-- Address -->
                            <div>
                                <label for="address" class="block text-sm font-medium text-slate-700 mb-2">Address *</label>
                                <textarea id="address" name="address" rows="3" required
                                          th:text="${customer?.billingAddress}"
                                          class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent resize-none"
                                          placeholder="Enter your complete address"></textarea>
                            </div>

                            <!-- Zip Code -->
                            <div>
                                <label for="zipCode" class="block text-sm font-medium text-slate-700 mb-2">Zip Code *</label>
                                <input type="text" id="zipCode" name="zipCode" required
                                       th:value="${customer?.postalCode}"
                                       class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"
                                       placeholder="Enter your zip code">
                            </div>

                            <!-- Phone Number -->
                            <div>
                                <label for="phoneNumber" class="block text-sm font-medium text-slate-700 mb-2">Phone Number *</label>
                                <input type="tel" id="phoneNumber" name="phoneNumber" required
                                       th:value="${customer?.phoneNumber}"
                                       class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"
                                       placeholder="Enter your phone number">
                            </div>
                        </div>
                    </div>

                    <!-- Right Side - Order Summary -->
                    <div class="space-y-6">
                        <!-- Order Summary -->
                        <div class="bg-white border border-slate-200 rounded-xl p-6">
                            <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-brand"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>
                                Order Summary
                            </h2>
                            
                            <div id="order-items" class="space-y-3 mb-6">
                                <!-- Order items will be populated by JavaScript -->
                            </div>
                            
                            <div class="space-y-3 border-t border-slate-200 pt-4">
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Subtotal</span>
                                    <span id="subtotal" class="font-semibold">LKR 0.00</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Delivery</span>
                                    <span class="font-semibold text-green-600">FREE</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Tax (15%)</span>
                                    <span id="tax" class="font-semibold">LKR 0.00</span>
                                </div>
                                <hr class="border-slate-200">
                                <div class="flex justify-between text-lg font-bold">
                                    <span>Total</span>
                                    <span id="total" class="text-brand">LKR 0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="max-w-6xl mx-auto mt-8 flex justify-between">
                    <a href="/cart" class="bg-slate-200 text-slate-700 px-8 py-3 rounded-lg hover:bg-slate-300 font-semibold">
                        Back to Cart
                    </a>
                    <button type="submit" class="bg-brand text-white px-8 py-3 rounded-lg hover-bg-brand-dark font-semibold text-lg">
                        Continue to Payment
                    </button>
                </div>
            </form>
        </main>
    </div>

    <!-- JavaScript for billing functionality -->
    <script>
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let selectedItems = JSON.parse(localStorage.getItem('selectedItems')) || [];
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            validateUserSession();
        });
        
        function validateUserSession() {
            // Check if user is logged in from server-side data
            const isLoggedIn = checkUserLoginStatus();
            
            if (!isLoggedIn) {
                // User is not logged in, show login required message
                showLoginRequiredMessage();
            } else {
                // User is logged in, proceed with billing page
                initializeBillingPage();
            }
        }
        
        function checkUserLoginStatus() {
            // Check if customer data is available from server-side session
            // The customer object is passed from the controller if user is logged in
            const customerElement = document.querySelector('[data-customer]');
            return customerElement !== null;
        }
        
        
        function showLoginRequiredMessage() {
            // Create a modal-like message
            const messageDiv = document.createElement('div');
            messageDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            messageDiv.innerHTML = `
                <div class="bg-white rounded-xl p-8 max-w-md mx-4 text-center">
                    <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-600"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 17a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M19.001 19.001 20 20l1-1"/><path d="m20 14-1-1-1 1"/><path d="M19.001 9.001 20 8l1 1"/><path d="m20 16 1 1-1 1"/></svg>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">Login Required</h3>
                    <p class="text-slate-600 mb-6">You need to be logged in to proceed with checkout. Please sign in to your account.</p>
                    <div class="flex space-x-3">
                        <button onclick="goToLogin()" class="flex-1 bg-brand text-white px-6 py-3 rounded-lg hover-bg-brand-dark font-semibold">
                            Sign In
                        </button>
                        <button onclick="goBackToCart()" class="flex-1 bg-slate-200 text-slate-700 px-6 py-3 rounded-lg hover:bg-slate-300 font-semibold">
                            Back to Cart
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(messageDiv);
        }
        
        function goToLogin() {
            // Store current page as return URL
            localStorage.setItem('returnUrl', '/billing');
            window.location.href = '/login';
        }
        
        function goBackToCart() {
            window.location.href = '/cart';
        }
        
        function initializeBillingPage() {
            renderOrderSummary();
            setupFormValidation();
        }
        
        function renderOrderSummary() {
            const orderItemsContainer = document.getElementById('order-items');
            const subtotalElement = document.getElementById('subtotal');
            const taxElement = document.getElementById('tax');
            const totalElement = document.getElementById('total');
            
            if (selectedItems.length === 0) {
                orderItemsContainer.innerHTML = '<p class="text-slate-500 text-center py-4">No items selected</p>';
                subtotalElement.textContent = 'LKR 0.00';
                taxElement.textContent = 'LKR 0.00';
                totalElement.textContent = 'LKR 0.00';
                return;
            }
            
            // Filter cart items based on selected items
            const selectedCartItems = cart.filter(item => selectedItems.includes(String(item.id)));
            
            let subtotal = 0;
            orderItemsContainer.innerHTML = selectedCartItems.map(item => {
                const itemTotal = (item.price || 0) * item.quantity;
                subtotal += itemTotal;
                
                return `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-slate-100 rounded-lg flex items-center justify-center">
                                ${item.imageUrl ? 
                                    `<img src="${item.imageUrl}" alt="${item.name}" class="w-full h-full object-contain rounded-lg" />` :
                                    `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>`
                                }
                            </div>
                            <div>
                                <p class="font-medium text-slate-800">${item.name}</p>
                                <p class="text-sm text-slate-500">Qty: ${item.quantity}</p>
                            </div>
                        </div>
                        <span class="font-semibold text-brand">LKR ${itemTotal.toFixed(2)}</span>
                    </div>
                `;
            }).join('');
            
            const tax = subtotal * 0.15; // 15% tax
            const total = subtotal + tax;
            
            subtotalElement.textContent = `LKR ${subtotal.toFixed(2)}`;
            taxElement.textContent = `LKR ${tax.toFixed(2)}`;
            totalElement.textContent = `LKR ${total.toFixed(2)}`;
        }
        
        function setupFormValidation() {
            const form = document.getElementById('billing-form');
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validate form
                const firstName = document.getElementById('firstName').value.trim();
                const lastName = document.getElementById('lastName').value.trim();
                const address = document.getElementById('address').value.trim();
                const zipCode = document.getElementById('zipCode').value.trim();
                const phoneNumber = document.getElementById('phoneNumber').value.trim();
                
                if (!firstName || !lastName || !address || !zipCode || !phoneNumber) {
                    showNotification('Please fill in all required fields.', 'error');
                    return;
                }
                
                // Validate phone number format
                const phoneRegex = /^[\+]?[0-9\s\-\(\)]{10,}$/;
                if (!phoneRegex.test(phoneNumber)) {
                    showNotification('Please enter a valid phone number.', 'error');
                    return;
                }
                
                // Store billing information
                const billingInfo = {
                    firstName,
                    lastName,
                    address,
                    zipCode,
                    phoneNumber
                };
                
                localStorage.setItem('billingInfo', JSON.stringify(billingInfo));
                
                // Redirect to payment page
                showNotification('Billing information saved successfully!', 'success');
                
                // Redirect to payment page after short delay
                setTimeout(() => {
                    window.location.href = '/payment';
                }, 1500);
            });
        }
        
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg text-white font-semibold ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Form is now auto-filled server-side using Thymeleaf
        // All form fields are populated with customer data from the session
    </script>
</body>
</html>
