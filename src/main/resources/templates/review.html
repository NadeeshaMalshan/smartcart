<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartCart - Review Order</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        .text-brand { color: #16a34a; }
        .bg-brand { background-color: #16a34a; }
        .border-brand { border-color: #16a34a; }
        .hover-bg-brand-dark:hover { background-color: #15803d; }
        .header-shadow { box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="bg-slate-100">

    <div class="bg-white min-h-screen">
        <!-- Header -->
        <header class="bg-white sticky top-0 z-50 header-shadow">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <a href="/" class="flex items-center space-x-2 text-2xl font-bold text-brand">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>
                    <span>SmartCart</span>
                </a>
                
                <!-- Navigation -->
                <div class="flex items-center space-x-4">
                    <!-- Orders Button (only show when logged in) -->
                    <a th:if="${isLoggedIn}" href="/orders" class="relative flex items-center space-x-2 bg-blue-100 text-blue-600 px-4 py-2 rounded-full hover:bg-blue-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><path d="M17.5 6.5h.01"/><path d="M6.5 6.5h.01"/><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Z"/></svg>
                        <span class="font-semibold">Orders</span>
                    </a>
                    
                    <!-- User Menu (only show when logged in) -->
                    <div th:if="${isLoggedIn}" class="relative">
                        <button class="flex items-center space-x-2 bg-slate-100 text-slate-700 px-4 py-2 rounded-full hover:bg-slate-200">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 17a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M19.001 19.001 20 20l1-1"/><path d="m20 14-1-1-1 1"/><path d="M19.001 9.001 20 8l1 1"/><path d="m20 16 1 1-1 1"/></svg>
                            <span class="font-semibold" th:text="${customer.username}">User</span>
                        </button>
                    </div>
                    
                    <a href="/payment" class="bg-brand text-white px-6 py-2 rounded-full hover-bg-brand-dark">
                        Back to Payment
                    </a>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8" data-customer th:if="${customer != null}">
            <!-- Progress Steps -->
            <div class="max-w-6xl mx-auto mb-8">
                <div class="flex items-center justify-center space-x-4 md:space-x-8">
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-brand text-white rounded-full flex items-center justify-center text-sm font-semibold">1</div>
                        <span class="text-sm font-medium text-slate-600">Cart</span>
                    </div>
                    <div class="w-12 md:w-16 h-0.5 bg-brand"></div>
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-brand text-white rounded-full flex items-center justify-center text-sm font-semibold">2</div>
                        <span class="text-sm font-medium text-slate-600">Billing</span>
                    </div>
                    <div class="w-12 md:w-16 h-0.5 bg-brand"></div>
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-brand text-white rounded-full flex items-center justify-center text-sm font-semibold">3</div>
                        <span class="text-sm font-medium text-slate-600">Payment</span>
                    </div>
                    <div class="w-12 md:w-16 h-0.5 bg-brand"></div>
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-brand text-white rounded-full flex items-center justify-center text-sm font-semibold">4</div>
                        <span class="text-sm font-medium text-brand">Review</span>
                    </div>
                </div>
            </div>

            <h1 class="text-3xl font-bold text-slate-800 mb-8 text-center">Review Your Order</h1>
            
            <div class="max-w-6xl mx-auto">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Left Side - Order Details -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Order Items -->
                        <div class="bg-white border border-slate-200 rounded-xl p-6">
                            <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-brand"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>
                                Order Items
                            </h2>
                            <div id="order-items" class="space-y-4">
                                <!-- Order items will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Billing Information -->
                        <div class="bg-white border border-slate-200 rounded-xl p-6">
                            <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-brand"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 17a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M19.001 19.001 20 20l1-1"/><path d="m20 14-1-1-1 1"/><path d="M19.001 9.001 20 8l1 1"/><path d="m20 16 1 1-1 1"/></svg>
                                Billing Information
                            </h2>
                            <div id="billing-summary" class="text-slate-600">
                                <!-- Billing info will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Payment Information -->
                        <div class="bg-white border border-slate-200 rounded-xl p-6">
                            <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-brand"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                                Payment Information
                            </h2>
                            <div id="payment-summary" class="text-slate-600">
                                <!-- Payment info will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Right Side - Order Summary & Actions -->
                    <div class="lg:col-span-1 space-y-6">
                        <!-- Order Summary -->
                        <div class="bg-white border border-slate-200 rounded-xl p-6 sticky top-24">
                            <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-brand"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>
                                Order Summary
                            </h2>
                            
                            <div class="space-y-3 mb-6">
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Subtotal</span>
                                    <span id="subtotal" class="font-semibold">LKR 0.00</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Delivery</span>
                                    <span class="font-semibold text-green-600">FREE</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Tax (15%)</span>
                                    <span id="tax" class="font-semibold">LKR 0.00</span>
                                </div>
                                <hr class="border-slate-200">
                                <div class="flex justify-between text-lg font-bold">
                                    <span>Total</span>
                                    <span id="total" class="text-brand">LKR 0.00</span>
                                </div>
                            </div>

                            <!-- Place Order Button -->
                            <button id="place-order-btn" class="w-full bg-brand text-white font-bold py-4 rounded-lg hover-bg-brand-dark text-lg mb-4">
                                Place Order
                            </button>
                            
                            <p class="text-xs text-slate-500 text-center">
                                By placing this order, you agree to our terms and conditions
                            </p>
                        </div>

                        <!-- Security Notice -->
                        <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600 mr-2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M9 12l2 2 4-4"/></svg>
                                <div>
                                    <p class="text-sm font-medium text-green-800">Secure Checkout</p>
                                    <p class="text-xs text-green-600">Your payment information is encrypted and secure</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Order Confirmation Modal -->
    <div id="order-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-xl p-8 max-w-md mx-4 text-center">
            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-600"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">Your Payment is Under Review</h3>
            <p class="text-slate-600 mb-6">Please wait while we review your payment. You will be notified once your order is confirmed.</p>
            <div class="space-y-3">
                <button onclick="goToHome()" class="w-full bg-brand text-white px-6 py-3 rounded-lg hover-bg-brand-dark font-semibold">
                    Continue Shopping
                </button>
                <button onclick="viewOrderDetails()" class="w-full bg-slate-200 text-slate-700 px-6 py-3 rounded-lg hover:bg-slate-300 font-semibold">
                    View Order Details
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript for review functionality -->
    <script>
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let selectedItems = JSON.parse(localStorage.getItem('selectedItems')) || [];
        let billingInfo = JSON.parse(localStorage.getItem('billingInfo')) || {};
        let paymentInfo = JSON.parse(localStorage.getItem('paymentInfo')) || {};
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            renderOrderItems();
            renderBillingSummary();
            renderPaymentSummary();
            renderOrderSummary();
            setupPlaceOrderButton();
        });
        
        function renderOrderItems() {
            const orderItemsContainer = document.getElementById('order-items');
            
            if (selectedItems.length === 0) {
                orderItemsContainer.innerHTML = '<p class="text-slate-500 text-center py-4">No items selected</p>';
                return;
            }
            
            // Filter cart items based on selected items
            const selectedCartItems = cart.filter(item => selectedItems.includes(String(item.id)));
            
            orderItemsContainer.innerHTML = selectedCartItems.map(item => {
                const itemTotal = (item.price || 0) * item.quantity;
                
                return `
                    <div class="flex items-center space-x-4 p-4 border border-slate-200 rounded-lg">
                        <div class="w-16 h-16 bg-slate-100 rounded-lg flex items-center justify-center">
                            ${item.imageUrl ? 
                                `<img src="${item.imageUrl}" alt="${item.name}" class="w-full h-full object-contain rounded-lg" />` :
                                `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>`
                            }
                        </div>
                        <div class="flex-grow">
                            <h3 class="font-semibold text-slate-800">${item.name}</h3>
                            <p class="text-sm text-slate-500">Quantity: ${item.quantity}</p>
                            <p class="text-sm text-slate-500">LKR ${(item.price || 0).toFixed(2)} each</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-brand text-lg">LKR ${itemTotal.toFixed(2)}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderBillingSummary() {
            const billingSummary = document.getElementById('billing-summary');
            
            if (billingInfo.firstName) {
                billingSummary.innerHTML = `
                    <div class="space-y-2">
                        <p><strong>Name:</strong> ${billingInfo.firstName} ${billingInfo.lastName}</p>
                        <p><strong>Address:</strong> ${billingInfo.address}</p>
                        <p><strong>Zip Code:</strong> ${billingInfo.zipCode}</p>
                        <p><strong>Phone:</strong> ${billingInfo.phoneNumber}</p>
                    </div>
                `;
            } else {
                billingSummary.innerHTML = '<p class="text-slate-500">No billing information available</p>';
            }
        }
        
        function renderPaymentSummary() {
            const paymentSummary = document.getElementById('payment-summary');
            
            if (paymentInfo.method) {
                if (paymentInfo.method === 'bank') {
                    paymentSummary.innerHTML = `
                        <div class="space-y-2">
                            <p><strong>Payment Method:</strong> Bank Transfer</p>
                            <p><strong>Bank Name:</strong> ${paymentInfo.bankName || 'N/A'}</p>
                            <p><strong>Account Holder:</strong> ${paymentInfo.accountHolderName || 'N/A'}</p>
                            <p><strong>Account Number:</strong> ${paymentInfo.accountNumber ? '****' + paymentInfo.accountNumber.slice(-4) : 'N/A'}</p>
                            <p><strong>Branch Code:</strong> ${paymentInfo.branchCode || 'N/A'}</p>
                            <p><strong>Instructions:</strong> Please complete bank transfer as instructed</p>
                        </div>
                    `;
                }
            } else {
                paymentSummary.innerHTML = '<p class="text-slate-500">No payment information available</p>';
            }
        }
        
        function renderOrderSummary() {
            const subtotalElement = document.getElementById('subtotal');
            const taxElement = document.getElementById('tax');
            const totalElement = document.getElementById('total');
            
            if (selectedItems.length === 0) {
                subtotalElement.textContent = 'LKR 0.00';
                taxElement.textContent = 'LKR 0.00';
                totalElement.textContent = 'LKR 0.00';
                return;
            }
            
            // Filter cart items based on selected items
            const selectedCartItems = cart.filter(item => selectedItems.includes(String(item.id)));
            
            const subtotal = selectedCartItems.reduce((sum, item) => {
                return sum + ((item.price || 0) * item.quantity);
            }, 0);
            
            const tax = subtotal * 0.15; // 15% tax
            const total = subtotal + tax;
            
            subtotalElement.textContent = `LKR ${subtotal.toFixed(2)}`;
            taxElement.textContent = `LKR ${tax.toFixed(2)}`;
            totalElement.textContent = `LKR ${total.toFixed(2)}`;
        }
        
        function setupPlaceOrderButton() {
            const placeOrderBtn = document.getElementById('place-order-btn');
            
            placeOrderBtn.addEventListener('click', async function() {
                // Validate that all information is available
                if (selectedItems.length === 0) {
                    showNotification('No items selected for order.', 'error');
                    return;
                }
                
                if (!billingInfo.firstName) {
                    showNotification('Billing information is missing.', 'error');
                    return;
                }
                
                if (!paymentInfo.method) {
                    showNotification('Payment information is missing.', 'error');
                    return;
                }
                
                // Disable button to prevent multiple clicks
                placeOrderBtn.disabled = true;
                placeOrderBtn.textContent = 'Placing Order...';
                
                try {
                    // Prepare order data
                    const selectedCartItems = cart.filter(item => selectedItems.includes(String(item.id)));
                    const productIds = selectedCartItems.map(item => item.id).join(',');
                    const productQuantities = selectedCartItems.map(item => item.quantity).join(',');
                    
                    const subtotal = selectedCartItems.reduce((sum, item) => {
                        return sum + ((item.price || 0) * item.quantity);
                    }, 0);
                    
                    // Get payslip location path from localStorage (if available)
                    const payslipLocationPath = localStorage.getItem('payslipLocationPath') || '';
                    
                    // Send order to backend
                    const formData = new FormData();
                    formData.append('productIds', productIds);
                    formData.append('productQuantities', productQuantities);
                    formData.append('subtotal', subtotal.toString());
                    formData.append('payslipLocationPath', payslipLocationPath);
                    formData.append('bankName', paymentInfo.bankName || '');
                    formData.append('accountHolderName', paymentInfo.accountHolderName || '');
                    formData.append('accountNumber', paymentInfo.accountNumber || '');
                    
                    const response = await fetch('/place-order', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Show review popup
                        showReviewPopup();
                        
                        // Clear cart and stored data after a delay
                        setTimeout(() => {
                            localStorage.removeItem('cart');
                            localStorage.removeItem('selectedItems');
                            localStorage.removeItem('billingInfo');
                            localStorage.removeItem('paymentInfo');
                            localStorage.removeItem('payslipLocationPath');
                        }, 3000);
                    } else {
                        showNotification(result.message || 'Failed to place order.', 'error');
                    }
                } catch (error) {
                    console.error('Error placing order:', error);
                    showNotification('Failed to place order. Please try again.', 'error');
                } finally {
                    // Re-enable button
                    placeOrderBtn.disabled = false;
                    placeOrderBtn.textContent = 'Place Order';
                }
            });
        }
        
        function showReviewPopup() {
            document.getElementById('order-confirmation-modal').style.display = 'flex';
        }
        
        function goToHome() {
            window.location.href = '/shopping';
        }
        
        function viewOrderDetails() {
            // In a real application, this would redirect to an order details page
            showNotification('Order details page would be implemented here.', 'success');
        }
        
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg text-white font-semibold ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>
